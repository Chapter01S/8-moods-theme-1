{% comment %}
	Cart Timer Bar - Customizable countdown timer for cart drawer
	
	Accepts:
	- block: {Object} Block settings object
{% endcomment %}

{% liquid
	assign timer_minutes = block.settings.timer_minutes | default: 10
	assign timer_text = block.settings.timer_text | default: 'Your order is reserved for {timer} mins!'
	assign bg_color = block.settings.timer_bg_color | default: '#000000'
	assign text_color = block.settings.timer_text_color | default: '#ffffff'
	assign padding = block.settings.timer_padding | default: 8
	assign text_size = block.settings.timer_text_size | default: 15
	assign border_width = block.settings.timer_border_width | default: 0
	assign border_color = block.settings.timer_border_color | default: '#ffffff'
	assign border_style = block.settings.timer_border_style | default: 'solid'
	assign block_id = block.id
%}

<style>
	.cart-timer-bar-{{ block_id }} {
		background-color: {{ bg_color }};
		padding: {{ padding }}px;
		text-align: center;
		width: 100%;
		box-sizing: border-box;
		margin: 0 !important;
		display: block !important;
		position: relative;
		z-index: 10;
		flex-shrink: 0;
		min-height: calc({{ text_size }}px + {{ padding }}px * 2);
		{% if border_width > 0 %}
			border-top: {{ border_width }}px {{ border_style }} {{ border_color }};
			border-bottom: {{ border_width }}px {{ border_style }} {{ border_color }};
		{% endif %}
	}
	
	.cart-timer-bar-{{ block_id }}:not(.timer-expired) {
		display: block !important;
		visibility: visible !important;
		opacity: 1 !important;
	}

	.cart-timer-text {
		color: {{ text_color }} !important;
		font-size: {{ text_size }}px;
        letter-spacing: var(--letter-spacing-body);
	}
	
	.cart-timer-bar-{{ block_id }}.timer-expired {
		display: none;
	}
</style>

{%- assign timer_placeholder = '{timer}' -%}
{%- assign initial_display = timer_text | replace: timer_placeholder, '0:00' -%}
<div class="cart-timer-bar-{{ block_id }}" id="cart-timer-bar-{{ block_id }}" data-block-id="{{ block_id }}" data-timer-minutes="{{ timer_minutes }}" data-timer-text="{{ timer_text | escape }}">
	<span class="cart-timer-text">{{ initial_display }}</span>
</div>

<script>
	(function() {
		const timerBar = document.getElementById('cart-timer-bar-{{ block_id }}');
		if (!timerBar) return;
		
		const blockId = '{{ block_id }}';
		const timerMinutes = parseInt(timerBar.getAttribute('data-timer-minutes'), 10) || 10;
		const timerText = timerBar.getAttribute('data-timer-text') || 'Complete your order in {timer}';
		const storageKey = `cart_timer_${blockId}`;
		const cartKeyKey = `cart_timer_cart_${blockId}`;
		
		// Get current cart state to detect changes
		const currentCartState = '{{ cart.item_count }}-{{ cart.total_price }}';
		const storedCartState = localStorage.getItem(cartKeyKey);
		
		// Get or initialize timer from localStorage
		let endTime = parseInt(localStorage.getItem(storageKey), 10);
		
		// Reset timer if cart has changed or timer doesn't exist or has expired
		const now = Date.now();
		if (!endTime || !storedCartState || storedCartState !== currentCartState || now >= endTime) {
			// Start a new timer
			endTime = now + (timerMinutes * 60 * 1000);
			localStorage.setItem(storageKey, endTime.toString());
			localStorage.setItem(cartKeyKey, currentCartState);
		}
		
		const timerTextEl = timerBar.querySelector('.cart-timer-text');
		let interval = null;
		
		function formatTime(ms) {
			const totalSeconds = Math.floor(ms / 1000);
			const minutes = Math.floor(totalSeconds / 60);
			const seconds = totalSeconds % 60;
			return `${minutes}:${String(seconds).padStart(2, '0')}`;
		}
		
		function updateTimer() {
			const now = Date.now();
			const remaining = endTime - now;
			
			if (remaining <= 0) {
				// Timer expired - remove from DOM and localStorage
				if (interval) {
					clearInterval(interval);
					interval = null;
				}
				timerBar.classList.add('timer-expired');
				timerBar.style.display = 'none';
				localStorage.removeItem(storageKey);
				localStorage.removeItem(cartKeyKey);
				return;
			}
			
			const formattedTime = formatTime(remaining);
			const displayText = timerText.replace('{timer}', formattedTime);
			
			if (timerTextEl) {
				timerTextEl.textContent = displayText;
			}
		}
		
		// Update immediately
		updateTimer();
		
		// Update every second
		interval = setInterval(updateTimer, 1000);
		
		// Clean up on page unload
		window.addEventListener('beforeunload', () => {
			if (interval) {
				clearInterval(interval);
			}
		});
	})();
</script>
