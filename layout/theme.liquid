<!doctype html>
{% liquid
  comment
    Detect RTL languages and apply RTL direction when enabled
    Calculate once and pass to snippets to avoid duplication
  endcomment
  assign rtl_locales = 'ar,he,fa,ur,sd,ku,dv' | split: ','
  assign is_rtl_locale = false
  if rtl_locales contains request.locale.iso_code
    assign is_rtl_locale = true
  endif
%}
<html
  class="js"
  lang="{{ request.locale.iso_code }}"
  {% if is_rtl_locale %}
    dir="rtl"
  {% else %}
    dir="ltr"
  {% endif %}
>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="theme-color" content="">
    <link rel="canonical" href="{{ canonical_url }}">

    {% comment %} Core Scripts {% endcomment %}
    <script src="{{ 'constants.js' | asset_url }}" defer="defer"></script>
    <script src="{{ 'pubsub.js' | asset_url }}" defer="defer"></script>
    <script src="{{ 'global.js' | asset_url }}" defer="defer"></script>
    <script src="{{ 'premium-attachment-kit.js' | asset_url }}" defer="defer"></script>
    <script src="{{ 'upsell-simple.js' | asset_url }}" defer="defer"></script>
    <script src="{{ 'details-disclosure.js' | asset_url }}" defer="defer"></script>
    <script src="{{ 'details-modal.js' | asset_url }}" defer="defer"></script>
    <script src="{{ 'search-form.js' | asset_url }}" defer="defer"></script>

    {%- if settings.animations_reveal_on_scroll -%}
      <script src="{{ 'animations.js' | asset_url }}" defer="defer"></script>
    {%- endif -%}

    {% comment %} Font Loading {% endcomment %}
    {%- unless settings.type_header_font.system? and settings.type_body_font.system? -%}
      <link rel="preconnect" href="https://fonts.shopifycdn.com" crossorigin>
    {%- endunless -%}

    <!-- Custom font CSS -->
    <link rel="stylesheet" href="{{ 'custom-font.css' | asset_url }}" type="text/css">

    <title>
      {{ page_title }}
      {%- if current_tags %} &ndash; tagged "{{ current_tags | join: ', ' }}"{% endif -%}
      {%- if current_page != 1 %} &ndash; Page {{ current_page }}{% endif -%}
      {%- unless page_title contains shop.name %} &ndash; {{ shop.name }}{% endunless -%}
    </title>

    {% if page_description %}
      <meta name="description" content="{{ page_description | escape }}">
    {% endif %}

    {% render 'meta-tags' %}

    {% comment %} Global Scripts {% endcomment %}
    <script>
      window.Shopify = window.Shopify || {};

      Shopify.license_key = '{{ settings.license_key }}';
      Shopify.money_format = "{{ shop.money_format }}";

      Shopify.formatMoney = function(cents, format) {
        if (typeof cents === 'string') {
          cents = cents.replace('.', '');
        }
        cents = parseInt(cents, 10);

        let value = '';
        {% raw %}
        const placeholderRegex = /{{\s*(\w+)\s*}}/;
        {% endraw %}
        const formatString = format || this.money_format;

        function defaultOption(opt, def) {
          return (typeof opt === 'undefined' ? def : opt);
        }

        function formatWithDelimiters(number, precision, thousands, decimal) {
          precision = defaultOption(precision, 2);
          thousands = defaultOption(thousands, ',');
          decimal = defaultOption(decimal, '.');

          if (isNaN(number) || number == null) return '0';

          number = (number / 100).toFixed(precision);

          const parts = number.split('.'),
                dollars = parts[0].replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1' + thousands),
                centsPart = parts[1] ? (decimal + parts[1]) : '';

          return dollars + centsPart;
        }

        const match = formatString.match(placeholderRegex);
        if (!match || !match[1]) return formatString;

        switch (match[1]) {
          case 'amount':
            value = formatWithDelimiters(cents, 2);
            break;
          case 'amount_no_decimals':
            value = formatWithDelimiters(cents, 0);
            break;
          case 'amount_with_comma_separator':
            value = formatWithDelimiters(cents, 2, '.', ',');
            break;
          case 'amount_no_decimals_with_comma_separator':
            value = formatWithDelimiters(cents, 0, '.', ',');
            break;
          default:
            value = formatWithDelimiters(cents, 2);
        }

        return formatString.replace(placeholderRegex, value);
      };
    </script>

    <script>
      if (Shopify.designMode) {
        document.documentElement.classList.add('shopify-design-mode');
      }

      document.addEventListener('alpine:init', function() {
        // Check if there's a premium-attachment-kit block with product-specific free gifts
        const premiumKit = document.querySelector('.premium-attachment-kit');
        let relyOnProductId = "{{ settings.rely_on_product.id }}";
        let freeGiftProductIds = [];
        let firstFreeGiftId = null;
        
        if (premiumKit) {
          const blockFreeGiftIds = premiumKit.getAttribute('data-free-gift-product-ids');
          const blockRelyOnProductId = premiumKit.getAttribute('data-rely-on-product-id');
          
          if (blockFreeGiftIds && blockFreeGiftIds.trim() !== '') {
            freeGiftProductIds = blockFreeGiftIds.split(',').filter(id => id.trim() !== '');
            firstFreeGiftId = freeGiftProductIds.length > 0 ? freeGiftProductIds[0] : null;
          }
          
          if (blockRelyOnProductId && blockRelyOnProductId.trim() !== '') {
            relyOnProductId = blockRelyOnProductId;
          }
        }
        
        // Fallback to global settings if no block-specific gifts found
        if (freeGiftProductIds.length === 0) {
          freeGiftProductIds = [
            "{{ settings['item_1_product'].id | default: '0' }}",
            "{{ settings['item_2_product'].id | default: '0' }}",
            "{{ settings['item_3_product'].id | default: '0' }}",
            "{{ settings['item_4_product'].id | default: '0' }}",
            "{{ settings['item_5_product'].id | default: '0' }}",
            "{{ settings['item_6_product'].id | default: '0' }}",
            "{{ settings['item_7_product'].id | default: '0' }}",
            "{{ settings['item_8_product'].id | default: '0' }}",
            "{{ settings['item_9_product'].id | default: '0' }}",
            "{{ settings['item_10_product'].id | default: '0' }}"
          ].filter(gift => gift !== "0");
          firstFreeGiftId = freeGiftProductIds.length > 0 ? freeGiftProductIds[0] : null;
        }
        
        if (!relyOnProductId || relyOnProductId === '') {
          relyOnProductId = "{{ settings.rely_on_product.id }}";
        }
        
        Alpine.store(AlpineStoreKeys.FREE_GIFT_STORE, { relyOnProductId, freeGiftProductIds });

        let freeShippingThreshhold = {{ settings.product_free_shipping | default: 0 | times: 100 }};
        Alpine.store(AlpineStoreKeys.FREE_SHIPPING_THRESHHOLD_STORE, { freeShippingThreshhold });

        // Update free-product-form ONLY if no premium-attachment-kit block is present
        // If premium-attachment-kit is present, free gifts are handled directly in the product form
        if (firstFreeGiftId && !premiumKit) {
          document.addEventListener('DOMContentLoaded', function() {
            const freeProductInput = document.querySelector('.free-product-form .product-variant-id');
            if (freeProductInput) {
              freeProductInput.value = firstFreeGiftId;
            }
          });
        }

        elxr.log('FreeGiftSetup', { relyOnProductId, freeGiftProductIds, firstFreeGiftId, source: premiumKit ? 'block' : 'global' }, 'debug');
        elxr.log('FreeShippingThreshholdSetup', { freeShippingThreshhold }, 'debug');
      });
    </script>

    <script>
      window.shopUrl = '{{ request.origin }}';
      window.routes = {
        cart_add_url: '{{ routes.cart_add_url }}',
        cart_change_url: '{{ routes.cart_change_url }}',
        cart_update_url: '{{ routes.cart_update_url }}',
        cart_url: '{{ routes.cart_url }}',
        predictive_search_url: '{{ routes.predictive_search_url }}',
      };

      window.cartStrings = {
        error: `{{ 'sections.cart.cart_error' | t }}`,
        quantityError: `{{ 'sections.cart.cart_quantity_error_html' | t: quantity: '[quantity]' }}`,
      };

      window.variantStrings = {
        addToCart: `{{ 'products.product.add_to_cart' | t }}`,
        soldOut: `{{ 'products.product.sold_out' | t }}`,
        unavailable: `{{ 'products.product.unavailable' | t }}`,
        unavailable_with_option: `{{ 'products.product.value_unavailable' | t: option_value: '[value]' }}`,
      };

      window.accessibilityStrings = {
        imageAvailable: `{{ 'products.product.media.image_available' | t: index: '[index]' }}`,
        shareSuccess: `{{ 'general.share.success_message' | t }}`,
        recipientFormExpanded: `{{ 'recipient.form.expanded' | t }}`,
        recipientFormCollapsed: `{{ 'recipient.form.collapsed' | t }}`,
        countrySelectorSearchCount: `{{ 'localization.country_results_count' | t: count: '[count]' }}`,
      };
    </script>

    {{ content_for_header }}

    {% comment %} Theme Variables {% endcomment %}
    {% render 'theme-variables', is_rtl_locale: is_rtl_locale %}

    {% comment %} Base Styles {% endcomment %}
    <style>
      *,
      *::before,
      *::after {
        box-sizing: inherit;
      }

      html {
        box-sizing: border-box;
        font-size: calc(var(--font-body-scale) * 62.5%);
        height: 100%;
      }

      body {
        display: flex;
        flex-direction: column;
        min-height: 100%;
        margin: 0;
        font-size: 1.5rem;
        letter-spacing: var(--letter-spacing-body);
        line-height: calc(1 + 0.8 / var(--font-body-scale));
        font-family: var(--font-body-family);
        font-style: var(--font-body-style);
        font-weight: var(--font-body-weight);
        color: rgba(var(--color-foreground), 0.75);
        background-color: rgb(var(--color-background));
      }

      section {
        color: rgba(var(--color-foreground), 0.75);
        background-color: rgb(var(--color-background));
      }

      #MainContent {
        flex-grow: 1;
      }

      @media screen and (min-width: 750px) {
        body {
          font-size: 1.6rem;
        }
      }
    </style>

    {% comment %} Button Styles {% endcomment %}
    {% render 'button-styles' %}

    {% comment %} Base Stylesheets {% endcomment %}
    {{ 'base.css' | asset_url | stylesheet_tag }}
    {{ 'custom-product-grid.css' | asset_url | stylesheet_tag }}
    {{ 'card-media-fix.css' | asset_url | stylesheet_tag }}
    {{ 'universal-font-fix.css' | asset_url | stylesheet_tag }}
    {{ 'app-typography-fix.css' | asset_url | stylesheet_tag }}
    {{ 'global-headings.css' | asset_url | stylesheet_tag }}
    {{ 'accent-typography.css' | asset_url | stylesheet_tag }}
    {{ 'selective-heading-fonts.css' | asset_url | stylesheet_tag }}
    {{ 'size-chart.css' | asset_url | stylesheet_tag }}
    {{ 'custom.css' | asset_url | stylesheet_tag }}
    <link rel="stylesheet" href="{{ 'component-cart-items.css' | asset_url }}" media="print" onload="this.media='all'">

    {% comment %} Conditional Assets {% endcomment %}
    {% render 'conditional-assets', is_rtl_locale: is_rtl_locale %}

    {% comment %} Typography Loaders {% endcomment %}
    {% render 'typography-loader' %}
    {% render 'global-typography-fix' %}
    {% render 'app-typography-fix' %}
    {% render 'global-button-fix' %}
    {% render 'enhanced-button-effects' %}
    {% render 'global-title-fix' %}

    {%- unless settings.type_body_font.system? -%}
      {% comment %}theme-check-disable AssetPreload{% endcomment %}
      <link rel="preload" as="font" href="{{ settings.type_body_font | font_url }}" type="font/woff2" crossorigin>
      {% comment %}theme-check-enable AssetPreload{% endcomment %}
    {%- endunless -%}
    {%- unless settings.type_header_font.system? -%}
      {% comment %}theme-check-disable AssetPreload{% endcomment %}
      <link rel="preload" as="font" href="{{ settings.type_header_font | font_url }}" type="font/woff2" crossorigin>
      {% comment %}theme-check-enable AssetPreload{% endcomment %}
    {%- endunless -%}

    {% comment %} Content Protection CSS {% endcomment %}
    {% if settings.enable_content_protection %}
    <style>
      /* Disable text selection */
      body {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      /* Re-enable selection for input fields */
      input, textarea {
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
      }
    </style>
    {% endif %}

    {% if settings.enable_image_protection %}
    <style>
      /* Prevent image dragging */
      img {
        -webkit-user-drag: none;
        -khtml-user-drag: none;
        -moz-user-drag: none;
        -o-user-drag: none;
        user-drag: none;
        pointer-events: none;
      }

      /* Re-enable pointer events for clickable images */
      a img {
        pointer-events: auto;
      }
    </style>
    {% endif %}
  </head>

  {% comment %} Body with Attributes {% endcomment %}
  <body
    class="
      color-1
      {% if settings.animations_hover_elements != 'none' %}animate--hover-{{ settings.animations_hover_elements }}{% endif %}
      {% if settings.enable_global_border_styling %} global-border-styling{% endif %}
      {% if settings.h1_use_heading_font %} h1-heading-font{% endif %}
      {% if settings.h2_use_heading_font %} h2-heading-font{% endif %}
      {% if settings.h3_use_heading_font %} h3-heading-font{% endif %}
      {% if settings.h4_use_heading_font %} h4-heading-font{% endif %}
      {% if settings.h5_use_heading_font %} h5-heading-font{% endif %}
      {% if settings.h6_use_heading_font %} h6-heading-font{% endif %}
    "
    data-button-radius="{{ settings.global_button_radius }}"
    data-apply-button-radius-to-all="{{ settings.apply_button_radius_to_all }}"
    {% if settings.enable_global_border_styling %}
      data-global-border-radius="{{ settings.global_border_radius }}"
      data-global-border-width="{{ settings.global_border_width }}"
    {% endif %}
    data-enable-global-borders="{{ settings.enable_global_border_styling }}"
  >
    {% if settings.type_accent_font != 'inherit' and settings.type_accent_font != 'serif' %}
      <span class="accent-font-loader" aria-hidden="true"></span>
    {% endif %}

    {% comment %} Skip to content link {% endcomment %}
    {% comment %}
      <a class="skip-to-content-link button visually-hidden" href="#MainContent">
        {{ 'accessibility.skip_to_text' | t }}
      </a>
    {% endcomment %}

    {% comment %} Cart Drawer Component {% endcomment %}
    {%- if settings.cart_type == 'drawer' -%}
      {%- section 'cart-drawer' -%}
      <script>
        const show_progress_bar = document.querySelector('.free-product-progress-bar-main');
        const freeProductVariantSelected = document.querySelector('.free_product_progress_bar_variant');
      </script>
    {%- endif -%}

    {% comment %} Free Product Form {% endcomment %}
    {% comment %} Only render if no premium-attachment-kit blocks exist on product pages {% endcomment %}
    {% unless template.name == 'product' %}
      {% render 'free-product-form' %}
    {% endunless %}

    {%- liquid
      comment
        Check if current page should hide header and footer
      endcomment
      assign hide_header_footer = false

      comment
        Check if current page handle is in the list of pages without header/footer
      endcomment
      if settings.pages_without_header_footer != blank and page.handle != blank
        assign page_handles_list = settings.pages_without_header_footer | newline_to_br | strip_newlines | split: '<br />'
        for page_handle in page_handles_list
          assign page_handle_trimmed = page_handle | strip
          if page_handle_trimmed == page.handle
            assign hide_header_footer = true
            break
          endif
        endfor
      endif

      comment
        Also check if the settings contain the page handle directly (fallback)
      endcomment
      if settings.pages_without_header_footer contains page.handle
        assign hide_header_footer = true
      endif
    -%}

    {%- unless hide_header_footer -%}
      {% sections 'header-group' %}
    {%- endunless -%}

    <main id="MainContent" class="content-for-layout focus-none" role="main" tabindex="-1">
      {{ content_for_layout }}
    </main>

    {%- unless hide_header_footer -%}
      {% sections 'footer-group' %}
    {%- endunless -%}

    <ul hidden>
      <li id="a11y-refresh-page-message">{{ 'accessibility.refresh_page' | t }}</li>
      <li id="a11y-new-window-message">{{ 'accessibility.link_messages.new_window' | t }}</li>
    </ul>

    {% comment %} External Scripts {% endcomment %}
    {% render 'external-scripts' %}

    <script>
      document.documentElement.className = document.documentElement.className.replace('no-js', 'js');
      if (Shopify.designMode) {
        document.documentElement.classList.add('shopify-design-mode');
      }
    </script>

    {% comment %} Content Protection JavaScript {% endcomment %}
    {% if settings.enable_content_protection %}
    <script>
      (function() {
        'use strict';

        // Disable right-click context menu
        document.addEventListener('contextmenu', function(e) {
          e.preventDefault();
          return false;
        });

        // Disable keyboard shortcuts
        document.addEventListener('keydown', function(e) {
          // Ctrl+C, Cmd+C (Copy)
          if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
            e.preventDefault();
            return false;
          }
          // Ctrl+U, Cmd+U (View Source)
          if ((e.ctrlKey || e.metaKey) && e.key === 'u') {
            e.preventDefault();
            return false;
          }
          // Ctrl+S, Cmd+S (Save)
          if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            return false;
          }
          // F12 (Developer Tools)
          if (e.key === 'F12') {
            e.preventDefault();
            return false;
          }
          // Ctrl+Shift+I, Cmd+Option+I (Developer Tools)
          if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'I') {
            e.preventDefault();
            return false;
          }
          // Ctrl+Shift+J, Cmd+Option+J (Console)
          if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'J') {
            e.preventDefault();
            return false;
          }
          // Ctrl+Shift+C, Cmd+Option+C (Inspect Element)
          if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'C') {
            e.preventDefault();
            return false;
          }
        });

        // Disable text selection via mouse
        document.addEventListener('selectstart', function(e) {
          // Allow selection in input and textarea fields
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            return true;
          }
          e.preventDefault();
          return false;
        });
      })();
    </script>
    {% endif %}

    {% if settings.enable_image_protection %}
    <script>
      (function() {
        'use strict';

        // Prevent image dragging
        document.addEventListener('dragstart', function(e) {
          if (e.target.tagName === 'IMG') {
            e.preventDefault();
            return false;
          }
        });
      })();
    </script>
    {% endif %}
  </body>
</html>